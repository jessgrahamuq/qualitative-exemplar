<style>
    @import url('https://fonts.googleapis.com/css2?family=Figtree:wght@400;500;600;700&display=swap');

    .expert-toggle-link {
        color: #a32035;
        font-family: 'Figtree', sans-serif;
        font-size: 18px;
        font-weight: 700;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
        margin-bottom: 20px;
        padding: 10px 15px;
        background: #fce8eb;
        border: 2px solid #a32035;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .expert-toggle-link:hover {
        background: #a32035;
        color: white;
        text-decoration: none;
    }

    .expert-toggle-link::before {
        content: "‚ñº ";
        display: inline-block;
        transition: transform 0.3s ease;
        margin-right: 8px;
        font-size: 14px;
    }

    .expert-toggle-link.collapsed::before {
        transform: rotate(-90deg);
    }

    .expert-iframe-container {
        width: 100%;
        height: 0;
        overflow: hidden;
        transition: height 0.5s ease;
        margin-bottom: 20px;
    }

    .expert-iframe-container.active {
        height: auto;
        overflow: visible;
    }

    .expert-iframe-container iframe {
        width: 100%;
        height: 600px; /* Initial height */
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        transition: height 0.3s ease;
    }

    /* Adjusted for narrower display */
    .expert-iframe-container iframe {
        min-width: 950px !important;
        transform-origin: top left;
        transform: scale(0.95);
        width: 105.26% !important;
    }

    @media (max-width: 768px) {
        .expert-iframe-container iframe {
            transform: scale(0.75);
            width: 133.33% !important;
            height: 650px;
        }
    }
</style>
<a href="javascript:void(0);" class="expert-toggle-link collapsed" onclick="toggleExpertVis(event)">Click to see experts' qualitative justifications for their assessments</a>
<div class="expert-iframe-container" id="expertVisContainer">
    <iframe
        id="expertIframe"
        src="https://jessgrahamuq.github.io/qualitative-exemplar/"
        title="Expert Qualitative Feedback Visualization"
        scrolling="no">
    </iframe>
</div>
<script>
    // Debug flag - enhanced debugging
    const DEBUG_IFRAME = true;
    let debugCounter = 0;

    function debugLog(message, data) {
        if (DEBUG_IFRAME) {
            debugCounter++;
            console.log(`[IFRAME DEBUG #${debugCounter}] ${message}`, data || '');
        }
    }

    function logAllDimensions() {
        const iframe = document.getElementById('expertIframe');
        if (iframe) {
            const container = document.getElementById('expertVisContainer');
            const rect = iframe.getBoundingClientRect();

            console.group(`üîç DIMENSION ANALYSIS #${debugCounter}`);
            console.log('üìê Iframe Dimensions:', {
                'style.height': iframe.style.height,
                'offsetHeight': iframe.offsetHeight,
                'clientHeight': iframe.clientHeight,
                'scrollHeight': iframe.scrollHeight,
                'boundingRect.height': rect.height
            });
            console.log('üì¶ Container:', {
                'className': container.className,
                'offsetHeight': container.offsetHeight,
                'scrollHeight': container.scrollHeight
            });
            console.log('üåç Window:', {
                'innerWidth': window.innerWidth,
                'innerHeight': window.innerHeight,
                'devicePixelRatio': window.devicePixelRatio
            });
            console.log('üéöÔ∏è Scale Factor:', window.innerWidth <= 768 ? 0.75 : 0.95);
            console.groupEnd();
        }
    }

    function toggleExpertVis(e) {
        e.preventDefault();
        debugLog('üéØ Toggle clicked');
        logAllDimensions();

        const link = document.querySelector('.expert-toggle-link');
        const container = document.getElementById('expertVisContainer');

        link.classList.toggle('collapsed');
        container.classList.toggle('active');

        debugLog('üì± Container active:', container.classList.contains('active'));

        // Log dimensions after toggle
        setTimeout(() => {
            logAllDimensions();
        }, 100);

        // Trigger height update when container becomes visible
        if (container.classList.contains('active')) {
            setTimeout(() => {
                const iframe = document.getElementById('expertIframe');
                if (iframe && iframe.contentWindow) {
                    debugLog('üì§ Requesting height from iframe');
                    iframe.contentWindow.postMessage({ type: 'request-height' }, '*');
                }
            }, 200);
        }
    }

    // Keep track of last set height and prevent rapid updates
    let lastSetHeight = 0;
    let lastUpdateTime = 0;
    const UPDATE_THROTTLE = 200; // Minimum time between updates in ms

    // Listen for height messages from iframe
    window.addEventListener('message', function(e) {
        debugLog('Message received:', e.data);

        // Check for the updated message type from your iframe
        if (e.data && e.data.type === 'iframe-height') {
            const now = Date.now();
            const timeSinceLastUpdate = now - lastUpdateTime;

            console.group(`üì® HEIGHT MESSAGE RECEIVED #${debugCounter}`);
            debugLog('‚è±Ô∏è Time since last update:', timeSinceLastUpdate + 'ms');
            debugLog('üìä Message data:', e.data);
            debugLog('üîÑ Current iframe height before change:', document.getElementById('expertIframe')?.style.height);

            // Log dimensions before processing
            logAllDimensions();

            // Throttle updates to prevent feedback loops
            if (timeSinceLastUpdate < UPDATE_THROTTLE) {
                debugLog('‚è∏Ô∏è Update throttled - too soon since last update');
                console.groupEnd();
                return;
            }

            const iframe = document.getElementById('expertIframe');
            if (iframe) {
                const newHeight = e.data.height;
                const heightDifference = Math.abs(newHeight - lastSetHeight);

                debugLog('üìè Height Analysis:', {
                    'newHeight': newHeight,
                    'lastSetHeight': lastSetHeight,
                    'difference': heightDifference,
                    'threshold': 10
                });

                // Only update if height changed significantly (more than 10px)
                if (heightDifference > 10) {
                    const scaleFactor = window.innerWidth <= 768 ? 0.75 : 0.95;
                    const adjustedHeight = Math.ceil(newHeight / scaleFactor);
                    const finalHeight = adjustedHeight + 30;

                    debugLog('üî¢ Calculations:', {
                        'scaleFactor': scaleFactor,
                        'adjustedHeight': adjustedHeight,
                        'padding': 30,
                        'finalHeight': finalHeight
                    });

                    iframe.style.height = finalHeight + 'px';
                    lastSetHeight = newHeight;
                    lastUpdateTime = now;

                    debugLog('‚úÖ Height updated to:', iframe.style.height);

                    // Log dimensions after change
                    setTimeout(() => {
                        logAllDimensions();
                    }, 50);
                } else {
                    debugLog('‚ö†Ô∏è Height change too small, ignoring:', heightDifference + 'px');
                }
            } else {
                debugLog('‚ùå ERROR: iframe not found');
            }
            console.groupEnd();
        }
    });

    // Set up iframe load listener
    document.addEventListener('DOMContentLoaded', function() {
        const iframe = document.getElementById('expertIframe');
        if (iframe) {
            iframe.addEventListener('load', function() {
                debugLog('Iframe loaded');

                // Request initial height after iframe loads
                setTimeout(() => {
                    if (iframe.contentWindow) {
                        iframe.contentWindow.postMessage({ type: 'request-height' }, '*');
                    }
                }, 500);
            });
        }
    });

    // Handle window resize to recalculate scale factors
    window.addEventListener('resize', function() {
        debugLog('Window resized, requesting height update');
        const iframe = document.getElementById('expertIframe');
        if (iframe && iframe.contentWindow) {
            iframe.contentWindow.postMessage({ type: 'request-height' }, '*');
        }
    });

    // Log initial setup
    debugLog('üöÄ Debug script loaded');
    debugLog('üîç Looking for iframe with ID:', 'expertIframe');
    debugLog('‚úÖ Iframe found:', !!document.getElementById('expertIframe'));

    // Auto-debug every 5 seconds to track what's happening
    setInterval(() => {
        if (document.getElementById('expertVisContainer')?.classList.contains('active')) {
            console.log('üîÑ AUTO-DEBUG: Container is active, logging dimensions...');
            logAllDimensions();
        }
    }, 5000);

    // Log when user interacts with anything
    document.addEventListener('click', (e) => {
        if (e.target.closest('#expertVisContainer')) {
            debugLog('üëÜ User clicked inside iframe container');
            setTimeout(logAllDimensions, 100);
        }
    });
</script>